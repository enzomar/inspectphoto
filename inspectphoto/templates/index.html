<!doctype html>

<html>

<head>
   <title>Inspect Photo</title>
   <!-- Required meta tags -->
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <link rel="stylesheet" href="{{ url_for('static',filename='css/bootstrap.min.css')}}">
   <link href="{{ url_for('static',filename='css/docs.css')}}" rel="stylesheet">
   <script src="{{ url_for('static',filename='js/bootstrap.bundle.min.js')}}"></script>
   <script src="{{ url_for('static',filename='js/ol.js')}}"></script>
   <style>
      .fill { 
            min-height: 100%;
            height: 100%;
         }
   </style>
</head>

<body style="background-color: black;">
   <footer class="mt-auto py-3 bg-dark">
      <div class="container">
         <div class="row">
            <div class="col text-start">
               <span class="text-muted fs-6">v0.1</span>
            </div>

               <div class="col" style="color: antiquewhite;">
                  <h1>Photo inspector</h1>
               </div>
            <div class="col text-end">
               <a href="https://www.paypal.com/donate/?business=7HRKKHKTPEXRU&no_recurring=0&currency_code=EUR" 
               target="_blank" type="button" class="btn btn-secondary btn-sm"> Buy me a beer!</a>
            </div>
         </div>
      </div>
   </footer>
   <div class="container">
      <!-- Content here -->
      <div class="row mt-1">
         <div class="input-group mb-3 mt-1">
            <input class="form-control" type="file" id="formFile">
            <div class="input-group-append">
               <button class="btn btn-outline-light" type="button" id="loadButton">Load</button>
             </div>
          </div>
      </div>
      <div class="row">
         <div class="col-4">
            <div class="row">
               <img id="preview"/>
            </div>
            <div class="row">
               <table class="table shadow p-2 m-2  rounded mb-30" id="info" style="background-color:antiquewhite">
               </table>
            </div>
         </div>
         <div class="col-8">
            <div id="map" style="width: 100%; height: 500px;"></div>
         </div>
      </div>
   </div>


   

   <script src="{{ url_for('static',filename='js/popper.min.js') }}"></script>
   <script src="{{ url_for('static',filename='js/jquery-3.6.1.min.js') }}"></script>
   <script src="{{ url_for('static',filename='js/ol.js') }}"></script>

   <script>

      var map;

      $(document).ready(function () {

         $("#info").hide(); 

         ol.proj.useGeographic();

         map = new ol.Map({
         controls: ol.control.defaults.defaults({
            zoom: true,
            attribution: true,
            rotate: false
         }),
         layers: [
            new ol.layer.Tile({ // TileLayer({
               source: new ol.source.OSM(),
            })
         ],
         target: 'map',
         view: new ol.View({
               zoom: 4
            })
         });

         showLocation(12.4573	,41.9019);

      });


      function buildLayer(long, lat){
         var place = [long, lat];
         var point = new ol.geom.Point(place);
         var circleFeature = new ol.Feature(point);
         var vectorSource = new ol.source.Vector({});
         vectorSource.addFeature(circleFeature);
         var vectorLayer = new ol.layer.Vector({
               source: vectorSource,
               style: {
                  'circle-radius': 9,
                  'circle-fill-color': 'red',
               }
         });
         return vectorLayer
      };

      function showLocation(long, lat, drawDot = true){

         place=[long, lat];
         map.getView().setCenter(place);
         var layers = map.getLayers().getArray();
         console.log(layers);
         if (layers.length > 0){
            map.removeLayer(map.getLayers().getArray()[1]);
         }
         if (drawDot){
            map.addLayer(buildLayer(long, lat));
         }
         
         return false;

      };

      function showInfo(info){

         $("#info").empty(); 
         $("#info").show(); 
         $.each(info, function(key, value) 
         {
            $("#info").append("<tr><td>"+key+"</td><td>"+value+"<td><tr>")
         });  
      };

      function showAll(info){
         showInfo(info);
         var long = info['Long'];
         var lat = info['Lat'];
         if (long && lat){
            showLocation(long,lat);
         }else{
            showLocation(12.4573	,41.9019, false);
         }
      };

      $('#loadButton').on('click', function (e) {

         var fd = new FormData();
         var file = $('#formFile')[0].files[0];
         fd.append('file', file);

         $("#preview").attr("src", URL.createObjectURL(file));

         $.ajax({
            url: '/inspect', 
            type: "POST",
            data: fd,
            contentType: false,
            processData: false,
            success: showAll
         })
      });
   </script>

</body>

</html>